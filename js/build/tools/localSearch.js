export default function initLocalSearch(){let e=config.path;if(e){let t,n=!1,o=!0;0===e.length?e="search.xml":e.endsWith("json")&&(o=!1);const r=document.querySelector(".search-input"),s=document.getElementById("search-result"),f=(e,t,n)=>{var o=e.length;if(0===o)return[];let r=0,l,s=[];for(n||(t=t.toLowerCase(),e=e.toLowerCase());-1<(l=t.indexOf(e,r));)s.push({position:l,word:e}),r=l+o;return s},m=(t,e,n,o)=>{let r=n[n.length-1],{position:l,word:s}=r,i=[],a=0;for(;l+s.length<=e&&0!==n.length;){s===o&&a++,i.push({position:l,length:s.length});const t=l+s.length;n.pop();for(let e=n.length-1;0<=e&&(r=n[e],l=r.position,s=r.word,!(t<=l));e--)n.pop()}return{hits:i,start:t,end:e,searchTextCount:a}},v=(n,e)=>{let o="",r=e.start;return e.hits.forEach(e=>{o+=n.substring(r,e.position);var t=e.position+e.length;o+=`<b class="search-keyword">${n.substring(e.position,t)}</b>`,r=t}),o+=n.substring(r,e.end)},l=()=>{if(n){let p=r.value.trim().toLowerCase(),l=p.split(/[-\s]+/),g=(1<l.length&&l.push(p),[]);if(0<p.length&&t.forEach(({title:e,content:s,url:n})=>{let t=e.toLowerCase(),o=s.toLowerCase(),r=[],i=[],a=0;if(l.forEach(e=>{r=r.concat(f(e,t,!1)),i=i.concat(f(e,o,!1))}),0<r.length||0<i.length){var c=r.length+i.length,h=([r,i].forEach(e=>{e.sort((e,t)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length)}),[]);0!==r.length&&(d=m(0,e.length,r,p),a+=d.searchTextCountInSlice,h.push(d));let l=[];for(;0!==i.length;){let e=i[i.length-1],{position:t,word:n}=e,o=t-20,r=t+80;o<0&&(o=0),(r=r<t+n.length?t+n.length:r)>s.length&&(r=s.length);var u=m(o,r,i,p);a+=u.searchTextCountInSlice,l.push(u)}l.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start);var d=parseInt(theme.navbar.search.top_n_per_article||1,10);0<=d&&(l=l.slice(0,d));let t="";t+=0!==h.length?`<li><a href="${n}" class="search-result-title">${v(e,h[0])}</a>`:`<li><a href="${n}" class="search-result-title">${e}</a>`,l.forEach(e=>{t+=`<a href="${n}"><p class="search-result">${v(s,e)}...</p></a>`}),t+="</li>",g.push({item:t,id:g.length,hitCount:c,searchTextCount:a})}}),1===l.length&&""===l[0])s.innerHTML='<div id="no-result"><i class="fa-solid fa-magnifying-glass fa-5x"></i></div>';else if(0===g.length)s.innerHTML='<div id="no-result"><i class="fa-solid fa-box-open fa-5x"></i></div>';else{g.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id);let t='<ul class="search-result-list">';g.forEach(e=>{t+=e.item}),t+="</ul>",s.innerHTML=t,window.pjax&&window.pjax.refresh(s)}}},i=()=>{fetch(config.root+e).then(e=>e.text()).then(e=>{n=!0,t=(t=o?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(e)).filter(e=>e.title).map(e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e));e=document.querySelector("#no-result");e&&(e.innerHTML='<i class="fa-solid fa-magnifying-glass fa-5x"></i>')})},a=(theme.navbar.search.preload&&i(),r&&r.addEventListener("input",l),document.querySelectorAll(".search-popup-trigger").forEach(e=>{e.addEventListener("click",()=>{document.body.style.overflow="hidden",document.querySelector(".search-pop-overlay").classList.add("active"),setTimeout(()=>r.focus(),500),n||i()})}),()=>{document.body.style.overflow="",document.querySelector(".search-pop-overlay").classList.remove("active")});document.querySelector(".search-pop-overlay").addEventListener("click",e=>{e.target===document.querySelector(".search-pop-overlay")&&a()}),document.querySelector(".search-input-field-pre").addEventListener("click",()=>{r.value="",r.focus(),l()}),document.querySelector(".popup-btn-close").addEventListener("click",a);try{swup.hooks.on("page:view",e=>{a()})}catch(e){}window.addEventListener("keyup",e=>{"Escape"===e.key&&a()})}else console.warn("`hexo-generator-searchdb` plugin is not installed!")}
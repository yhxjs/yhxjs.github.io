import{main as e}from"../main.js";import{initTOC as t}from"../layouts/toc.js";function initHBE(){const c=window.crypto||window.msCrypto,s=window.localStorage,l="hexo-blog-encrypt:#"+window.location.pathname,d=o("too young too simple"),m=o("sometimes naive!"),n=document.getElementById("hexo-blog-encrypt"),a=n.dataset.wpm,y=n.dataset.whm,r=n.getElementsByTagName("script").hbeData,h=r.innerText,u=r.dataset.hmacdigest;function p(e){return new Uint8Array(e.match(/[\da-f]{2}/gi).map(e=>parseInt(e,16)))}function o(e){for(var t=e.length,n=0,r=new Array,o=0;o<t;){var a=e.codePointAt(o);a<128?(r[n++]=a,o++):127<a&&a<2048?(r[n++]=a>>6|192,r[n++]=63&a|128,o++):2047<a&&a<65536?(r[n++]=a>>12|224,r[n++]=a>>6&63|128,r[n++]=63&a|128,o++):(r[n++]=a>>18|240,r[n++]=a>>12&63|128,r[n++]=a>>6&63|128,r[n++]=63&a|128,o+=2)}return new Uint8Array(r)}async function g(n,r,i){var o=p(h);return c.subtle.decrypt({name:"AES-CBC",iv:r},n,o.buffer).then(async n=>{var r,o,a,n=(new TextDecoder).decode(n);if(n.startsWith("<hbe-prefix></hbe-prefix>"))return(o=document.createElement("button")).textContent="Encrypt again",o.type="button",o.classList.add("hbe-button"),o.addEventListener("click",()=>{window.localStorage.removeItem(l),window.location.reload()}),document.getElementById("hexo-blog-encrypt").style.display="inline",document.getElementById("hexo-blog-encrypt").innerHTML="",document.getElementById("hexo-blog-encrypt").appendChild((a=n,(r=document.createElement("div")).innerHTML=a,r.querySelectorAll("script").forEach(async e=>{e.replaceWith(await async function(t){let n=document.createElement("script");return["type","text","src","crossorigin","defer","referrerpolicy"].forEach(e=>{t[e]&&(n[e]=t[e])}),n}(e))}),await r)),document.getElementById("hexo-blog-encrypt").appendChild(o),document.querySelectorAll("img").forEach(e=>{e.getAttribute("data-src")&&!e.src&&(e.src=e.getAttribute("data-src"))}),e.refresh(),t(),a=new Event("hexo-blog-decrypt"),window.dispatchEvent(a),r=i,o=n,o=(new TextEncoder).encode(o),a=p(u),r=await c.subtle.verify({name:"HMAC",hash:"SHA-256"},r,a,o),console.log("Verification result: "+r),r||(alert(y),console.log(y+", got ",a," but proved wrong.")),r;throw"Decode successfully but not start with KnownPrefix."}).catch(e=>(alert(a),console.log(e),!1))}var i=JSON.parse(s.getItem(l));if(i){console.log(`Password got from localStorage(${l}): `,i);const f=p(i.iv).buffer,d=i.dk,m=i.hmk;c.subtle.importKey("jwk",d,{name:"AES-CBC",length:256},!0,["decrypt"]).then(t=>{c.subtle.importKey("jwk",m,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"]).then(e=>{g(t,f,e).then(e=>{e||s.removeItem(l)})})})}n.addEventListener("keydown",async e=>{if(e.isComposing||"Enter"===e.key){const e=document.getElementById("hbePass").value,r=(t=e,n=new TextEncoder,await c.subtle.importKey("raw",n.encode(t),{name:"PBKDF2"},!1,["deriveKey","deriveBits"])),o=(n=r,await c.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:d.buffer,iterations:1024},n,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"])),a=(t=r,await c.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:d.buffer,iterations:1024},t,{name:"AES-CBC",length:256},!0,["decrypt"])),i=(n=r,await c.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:m.buffer,iterations:512},n,128));g(a,i,o).then(e=>{console.log("Decrypt result: "+e),e&&c.subtle.exportKey("jwk",a).then(t=>{c.subtle.exportKey("jwk",o).then(e=>{e={dk:t,iv:function(e){if("object"!=typeof e||null===e||"number"!=typeof e.byteLength)throw new TypeError("Expected input to be an ArrayBuffer");for(var t,n=new Uint8Array(e),r="",o=0;o<n.length;o++)r+=1===(t=n[o].toString(16)).length?"0"+t:t;return r}(i),hmk:e};s.setItem(l,JSON.stringify(e))})})})}var t,n})}export{initHBE};